<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Oficina - Gestão de Pátio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; }
    .status-column { background: #e2e8f0; border-radius: 12px; display: flex; flex-direction: column; transition: all 0.3s ease; }
    .vehicle-list { flex-grow: 1; transition: all 0.3s ease-in-out; max-height: 1000px; overflow: hidden; }
    .vehicle-list.collapsed { max-height: 0; margin-top: 0 !important; }
    .vehicle-card {
      background: white; border-radius: 8px; padding: 8px; margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: all 0.2s ease-in-out; border-left: 5px solid;
    }
    .vehicle-card:hover { transform: translateY(-3px); box-shadow: 0 8px 12px rgba(0,0,0,0.1); }
    .vehicle-card.status-Aguardando-Mecanico { border-left-color: #f59e0b; }
    .vehicle-card.status-Em-Analise { border-left-color: #8b5cf6; }
    .vehicle-card.status-Orcamento-Enviado { border-left-color: #06b6d4; }
    .vehicle-card.status-Aguardando-Aprovacao { border-left-color: #d946ef; }
    .vehicle-card.status-Servico-Autorizado { border-left-color: #10b981; }
    .vehicle-card.status-Em-Execucao { border-left-color: #ef4444; }
    .vehicle-card.status-Finalizado-Aguardando-Retirada { border-left-color: #f97316; }
    .vehicle-card.status-Entregue { border-left-color: #6b7280; opacity: 0.9; }
    .modal { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); }
    .modal-content { background: #f8fafc; border-radius: 16px; max-height: 90vh; }
    .btn { transition: all 0.2s ease; border-radius: 8px; font-weight: 600; }
    .btn:hover { transform: translateY(-2px); }
    .timeline { border-left: 3px solid #e5e7eb; }
    .timeline-item { position: relative; padding-left: 2.5rem; }
    .timeline-icon {
      position: absolute; left: -0.875rem; top: 0; width: 1.75rem; height: 1.75rem;
      border-radius: 9999px; background-color: white; border: 3px solid;
      display: flex; align-items: center; justify-content: center;
    }
    .timeline-item-log .timeline-icon { border-color: #3b82f6; color: #3b82f6; }
    .timeline-item-status .timeline-icon { border-color: #10b981; color: #10b981; }
    .timeline-item-value .timeline-icon { border-color: #f59e0b; color: #f59e0b; }
    #attention-panel-container { transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; max-height: 500px; overflow: hidden; }
    #attention-panel-container.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; border-bottom: 0; }
    #attention-panel { font-family: 'Orbitron', sans-serif; background: #0f172a; border-bottom: 4px solid #334155; }
    .attention-box { transition: all 0.5s ease; }
    .blinking-aguardando { animation: blink-aguardando 2s infinite; }
    .blinking-autorizado { animation: blink-autorizado 2s infinite; }
    .blinking-finalizado { animation: blink-finalizado 2s infinite; }
    @keyframes blink-aguardando { 50% { background-color: #4a2f0a; } }
    @keyframes blink-autorizado { 50% { background-color: #064e3b; } }
    @keyframes blink-finalizado { 50% { background-color: #7c2d12; } }
    #lightbox {
        background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
        transition: opacity 0.3s ease;
    }
    #lightbox img, #lightbox video { max-height: 80vh; max-width: 80vw; }
    #alert-led {
        width: 16px; height: 16px; background-color: #ef4444;
        border-radius: 50%; box-shadow: 0 0 12px #ef4444, inset 0 0 4px white;
        animation: blink-led 1s infinite;
    }
    @keyframes blink-led { 50% { opacity: 0.2; } }
    .column-led {
        width: 8px; height: 8px; background-color: #22c55e;
        border-radius: 50%; box-shadow: 0 0 5px #22c55e;
    }
  </style>
</head>
<body class="bg-gray-100">

  <div id="userScreen" class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">CHEVRON</h1>
      <p class="text-xl font-semibold text-blue-800">Bosch Car Service</p>
      <p class="text-gray-500 my-8">Selecione seu perfil para iniciar</p>
      <div id="userList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
    </div>
  </div>

  <div id="app" class="hidden">
    <header class="bg-white shadow-md sticky top-0 z-40">
      <div id="attention-panel-container">
        <div id="attention-panel" class="grid grid-cols-1 sm:grid-cols-3 gap-2 p-2"></div>
      </div>
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div>
                <h1 class="text-xl font-bold text-gray-800">CHEVRON</h1>
                <p class="text-sm font-semibold text-blue-800 -mt-1">Bosch Car Service</p>
            </div>
            <div id="alert-led" class="hidden"></div>
            <button id="toggle-panel-btn" class="text-gray-400 hover:text-blue-800 p-1" title="Mostrar/Ocultar Painel de Alertas">
                <i class='bx bxs-chevron-up text-2xl'></i>
            </button>
        </div>
        <div class="flex items-center gap-4">
          <button id="addOSBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 flex items-center gap-2">
            <i class='bx bx-plus-circle'></i><span class="hidden sm:inline">Nova O.S.</span>
          </button>
          <div class="text-right">
            <p id="currentUserName" class="font-semibold text-gray-700"></p>
            <button id="logoutButton" class="text-sm text-red-500 hover:text-red-700">Sair</button>
          </div>
        </div>
      </div>
    </header>
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-8 gap-6" id="kanbanBoard"></div>
    </main>
  </div>

  <div id="osModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="modal-content w-full max-w-lg overflow-y-auto">
      <form id="osForm" class="p-6">
        <h2 id="osModalTitle" class="text-2xl font-bold text-gray-800 mb-6">Nova Ordem de Serviço</h2>
        <input type="hidden" id="osId">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <input id="osPlaca" type="text" placeholder="Placa" required class="p-2 border rounded w-full">
          <input id="osModelo" type="text" placeholder="Modelo do Veículo" required class="p-2 border rounded w-full">
          <input id="osCliente" type="text" placeholder="Nome do Cliente" required class="p-2 border rounded w-full">
          <input id="osTelefone" type="tel" placeholder="Telefone" class="p-2 border rounded w-full">
          <div class="col-span-1 sm:col-span-2">
             <input id="osKm" type="number" placeholder="KM do Veículo" class="p-2 border rounded w-full">
          </div>
          <select id="osResponsavel" required class="p-2 border rounded w-full col-span-1 sm:col-span-2"></select>
          <textarea id="osObservacoes" placeholder="Observações Iniciais / Queixa do Cliente" rows="3" class="p-2 border rounded w-full col-span-1 sm:col-span-2"></textarea>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" class="btn-close-modal btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2">Cancelar</button>
          <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="detailsModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="modal-content w-full max-w-4xl overflow-y-auto">
      <div class="p-6 sm:p-8">
        <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
          <div class="flex justify-between items-start">
            <div>
              <h2 id="detailsPlacaModelo" class="text-3xl font-bold text-gray-800"></h2>
              <p id="detailsCliente" class="text-lg text-gray-600"></p>
              <p id="detailsKm" class="text-lg text-blue-800 font-bold mt-1"></p>
            </div>
            <button class="btn-close-modal text-3xl text-gray-400 hover:text-gray-600">&times;</button>
          </div>
          <div id="responsiblesContainer" class="mt-4 pt-4 border-t text-sm text-gray-500 grid grid-cols-2 sm:grid-cols-4 gap-2"></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
          <div class="lg:col-span-3">
            <details id="media-gallery-container" class="bg-white rounded-lg shadow-sm p-4 mb-6">
              <summary class="font-bold text-xl text-gray-700 cursor-pointer">Galeria de Mídia</summary>
              <div id="thumbnail-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-2 mt-4"></div>
            </details>
            <h3 class="font-bold text-xl mb-4 text-gray-700">Histórico da O.S.</h3>
            <div id="timelineContainer" class="space-y-8 timeline"></div>
          </div>
          <div class="lg:col-span-2">
            <div class="bg-white p-4 rounded-lg shadow-sm sticky top-4">
              <h3 class="font-bold text-xl mb-4 text-gray-700">Adicionar Atualização</h3>
              <form id="logForm" class="space-y-4">
                <input type="hidden" id="logOsId">
                <textarea id="logDescricao" placeholder="Descrição do serviço, peça, observação..." rows="3" required class="p-2 border rounded w-full"></textarea>
                <div class="flex gap-4">
                  <input id="logPecas" type="text" placeholder="Peças (opcional)" class="p-2 border rounded w-1/2">
                  <input id="logValor" type="number" step="0.01" placeholder="Valor R$ (opcional)" class="p-2 border rounded w-1/2">
                </div>
                <div>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" id="openCameraBtn" class="w-full btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 flex items-center justify-center gap-2 cursor-pointer">
                            <i class='bx bxs-camera'></i> Câmera
                        </button>
                        <button type="button" id="openGalleryBtn" class="w-full btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 flex items-center justify-center gap-2 cursor-pointer">
                            <i class='bx bxs-image-add'></i> Galeria
                        </button>
                    </div>
                  <input id="media-input" type="file" class="hidden" multiple>
                  <p id="fileName" class="text-sm text-gray-500 mt-1 truncate"></p>
                </div>
                <button type="submit" class="w-full btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 flex items-center justify-center gap-2">
                  <i class='bx bx-message-square-add'></i> Adicionar ao Histórico
                </button>
              </form>
              <div id="post-log-actions" class="hidden mt-4 border-t pt-4 space-y-2">
                <h4 class="font-semibold text-gray-700 text-center">Registro Salvo! Mover O.S.?</h4>
                <button id="btn-move-next" class="w-full btn bg-blue-500 hover:bg-blue-600 text-white">Avançar Status</button>
                <button id="btn-move-prev" class="w-full btn bg-yellow-500 hover:bg-yellow-600 text-white">Retroceder Status</button>
                <button id="btn-stay" class="w-full btn bg-gray-400 hover:bg-gray-500 text-white">Apenas Atualizar</button>
              </div>
              <form id="kmUpdateForm" class="mt-4 border-t pt-4">
                <h4 class="font-semibold text-gray-700 mb-2">Atualizar KM</h4>
                <div class="flex gap-2">
                    <input id="updateKmInput" type="number" placeholder="Nova KM" class="p-2 border rounded w-full">
                    <button type="submit" class="btn bg-blue-500 hover:bg-blue-600 text-white px-3" title="Salvar KM"><i class='bx bx-save'></i></button>
                </div>
              </form>
              <div class="mt-6 flex justify-end">
                <button id="deleteOsBtn" class="btn bg-red-600 hover:bg-red-700 text-white p-2" title="Excluir O.S.">
                  <i class='bx bx-trash text-xl'></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="lightbox" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
    <div class="absolute inset-0" id="lightbox-close-bg"></div>
    <div class="relative bg-black bg-opacity-50 p-4 rounded-lg">
        <div id="lightbox-content" class="flex items-center justify-center"></div>
        <button id="lightbox-close" class="absolute -top-2 -right-2 bg-white text-black rounded-full h-8 w-8 flex items-center justify-center">&times;</button>
        <button id="lightbox-prev" class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/50 hover:bg-white text-black p-2 rounded-full"><i class='bx bx-chevron-left text-2xl'></i></button>
        <button id="lightbox-next" class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/50 hover:bg-white text-black p-2 rounded-full"><i class='bx bx-chevron-right text-2xl'></i></button>
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-4">
            <a id="lightbox-download" href="#" download class="bg-blue-600 text-white p-2 rounded-full"><i class='bx bxs-download'></i></a>
            <button id="lightbox-copy" class="bg-blue-600 text-white p-2 rounded-full"><i class='bx bx-copy'></i></button>
        </div>
  </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB5JpYm8l0AlF5ZG3HtkyFZgmrpsUrDhv0",
      authDomain: "dashboard-oficina-pro.firebaseapp.com",
      databaseURL: "https://dashboard-oficina-pro-default-rtdb.firebaseio.com",
      projectId: "dashboard-oficina-pro",
      storageBucket: "dashboard-oficina-pro.appspot.com",
      messagingSenderId: "736157192887",
      appId: "1:736157192887:web:c23d3daade848a33d67332"
    };
    
    const imgbbApiKey = "57cb1c5a02fb6e5ef2700543d6245b70";

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 500);
        }, 4000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      let currentUser = null;
      let allServiceOrders = {};
      let lightboxMedia = [];
      let currentLightboxIndex = 0;
      let filesToUpload = null;
      let vehiclesTriggeringAlert = new Set();
      
      const USERS = [
        { name: 'Augusto', role: 'Gestor' }, { name: 'William Barbosa', role: 'Atendente' },
        { name: 'Thiago Ventura Valencio', role: 'Atendente' }, { name: 'Fernando', role: 'Mecânico' },
        { name: 'Gustavo', role: 'Mecânico' }, { name: 'Marcelo', role: 'Mecânico' }
      ];
      const STATUS_LIST = [
        'Aguardando-Mecanico', 'Em-Analise', 'Orcamento-Enviado', 'Aguardando-Aprovacao',
        'Servico-Autorizado', 'Em-Execucao', 'Finalizado-Aguardando-Retirada', 'Entregue'
      ];
      const ATTENTION_STATUSES = {
        'Aguardando-Mecanico': { label: 'AGUARDANDO MECÂNICO', color: 'yellow', blinkClass: 'blinking-aguardando' },
        'Servico-Autorizado': { label: 'SERVIÇO AUTORIZADO', color: 'green', blinkClass: 'blinking-autorizado' },
        'Finalizado-Aguardando-Retirada': { label: 'FINALIZADO / RETIRADA', color: 'orange', blinkClass: 'blinking-finalizado' }
      };

      const userScreen = document.getElementById('userScreen');
      const app = document.getElementById('app');
      const userList = document.getElementById('userList');
      const kanbanBoard = document.getElementById('kanbanBoard');
      const addOSBtn = document.getElementById('addOSBtn');
      const logoutButton = document.getElementById('logoutButton');
      const osModal = document.getElementById('osModal');
      const osForm = document.getElementById('osForm');
      const detailsModal = document.getElementById('detailsModal');
      const logForm = document.getElementById('logForm');
      const kmUpdateForm = document.getElementById('kmUpdateForm');
      const attentionPanel = document.getElementById('attention-panel');
      const attentionPanelContainer = document.getElementById('attention-panel-container');
      const togglePanelBtn = document.getElementById('toggle-panel-btn');
      const lightbox = document.getElementById('lightbox');
      const mediaInput = document.getElementById('media-input');
      const openCameraBtn = document.getElementById('openCameraBtn');
      const openGalleryBtn = document.getElementById('openGalleryBtn');
      const alertLed = document.getElementById('alert-led');
      const postLogActions = document.getElementById('post-log-actions');

      const formatStatus = (status) => status.replace(/-/g, ' ');

      const updateAttentionPanel = () => {
        attentionPanel.innerHTML = Object.entries(ATTENTION_STATUSES).map(([statusKey, config]) => {
            const vehiclesInStatus = Object.values(allServiceOrders).filter(os => os.status === statusKey);
            const hasVehicles = vehiclesInStatus.length > 0;
            const blinkingClass = hasVehicles ? config.blinkClass : '';
            const vehicleListHTML = hasVehicles 
                ? vehiclesInStatus.map(os => `<p class="cursor-pointer attention-vehicle" data-os-id="${os.id}">${os.placa} - ${os.modelo}</p>`).join('')
                : `<p class="text-gray-600">- Vazio -</p>`;

            return `
                <div class="attention-box p-2 rounded-md bg-gray-800 border-2 border-gray-700 ${blinkingClass}" data-status-key="${statusKey}">
                    <h3 class="text-center text-${config.color}-400 font-bold text-xs sm:text-sm truncate">${config.label}</h3>
                    <div class="mt-1 text-center text-white text-xs space-y-1 h-16 overflow-y-auto">
                        ${vehicleListHTML}
                    </div>
                </div>
            `;
        }).join('');
      };

      const loginUser = (user) => {
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(user));
        document.getElementById('currentUserName').textContent = user.name;
        userScreen.classList.add('hidden');
        app.classList.remove('hidden');
        listenToServiceOrders();
      };

      const checkLoggedInUser = () => {
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) loginUser(JSON.parse(storedUser));
        else {
          userList.innerHTML = USERS.map(user =>
            `<div class="p-4 bg-gray-100 rounded-lg hover:bg-blue-100 cursor-pointer user-btn" data-user='${JSON.stringify(user)}'>
              <p class="font-semibold">${user.name}</p><p class="text-sm text-gray-500">${user.role}</p>
            </div>`
          ).join('');
        }
      };

      const renderKanban = (deliveredFilter = '') => {
        const collapsedState = JSON.parse(localStorage.getItem('collapsedColumns')) || {};
        kanbanBoard.innerHTML = STATUS_LIST.map(status => {
          const isCollapsed = collapsedState[status];
          const isDeliveredColumn = status === 'Entregue';
          const searchInputHTML = isDeliveredColumn ? `
            <input type="search" id="searchDeliveredInput" placeholder="Buscar em Entregues..." 
                   class="w-full p-2 mb-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          ` : '';
          const hasVehicles = Object.values(allServiceOrders).some(os => os.status === status);
          const columnLedHTML = isCollapsed && hasVehicles ? `<div class="column-led ml-2"></div>` : '';

          return `
            <div class="status-column p-3">
              <div class="flex justify-between items-center cursor-pointer toggle-column-btn" data-status="${status}">
                <div class="flex items-center">
                  <h3 class="font-bold text-gray-700 px-1">${formatStatus(status)}</h3>
                  ${columnLedHTML}
                </div>
                <i class='bx bxs-chevron-down transition-transform ${isCollapsed ? 'rotate-180' : ''}'></i>
              </div>
              ${searchInputHTML}
              <div class="space-y-3 mt-3 vehicle-list ${isCollapsed ? 'collapsed' : ''}" data-status="${status}"></div>
            </div>`;
        }).join('');

        const lowerCaseFilter = deliveredFilter.toLowerCase();

        Object.values(allServiceOrders).forEach(os => {
          if (os.status === 'Entregue' && deliveredFilter) {
            const searchableText = `${os.placa} ${os.modelo} ${os.cliente}`.toLowerCase();
            if (!searchableText.includes(lowerCaseFilter)) return;
          }
          const list = kanbanBoard.querySelector(`.vehicle-list[data-status="${os.status}"]`);
          if (list) list.insertAdjacentHTML('beforeend', createCardHTML(os));
        });
        
        updateAttentionPanel();

        if (document.getElementById('searchDeliveredInput')) {
          document.getElementById('searchDeliveredInput').value = deliveredFilter;
          document.getElementById('searchDeliveredInput').addEventListener('input', (e) => {
            renderKanban(e.target.value);
          });
        }
      };

      const createCardHTML = (os) => {
        const currentIndex = STATUS_LIST.indexOf(os.status);
        const prevStatus = currentIndex > 0 ? STATUS_LIST[currentIndex - 1] : null;
        const nextStatus = currentIndex < STATUS_LIST.length - 1 ? STATUS_LIST[currentIndex + 1] : null;
        const prevButton = prevStatus ? `<button data-os-id="${os.id}" data-new-status="${prevStatus}" class="btn-move-status p-2 rounded-full hover:bg-gray-200"><i class='bx bx-chevron-left text-2xl text-gray-600'></i></button>` : `<div class="w-10 h-10"></div>`;
        const nextButton = nextStatus ? `<button data-os-id="${os.id}" data-new-status="${nextStatus}" class="btn-move-status p-2 rounded-full hover:bg-gray-200"><i class='bx bx-chevron-right text-2xl text-gray-600'></i></button>` : `<div class="w-10 h-10"></div>`;

        let responsibleInfo = `<p class="text-xs text-gray-400">Resp.: ${os.responsible}</p>`;
        if (os.status === 'Em-Execucao' && os.responsibleForService) {
            responsibleInfo = `<p class="text-xs text-red-500 font-semibold">Mec.: ${os.responsibleForService}</p>`;
        } else if (os.status === 'Em-Analise' && os.responsibleForBudget) {
            responsibleInfo = `<p class="text-xs text-purple-500 font-semibold">Orçam.: ${os.responsibleForBudget}</p>`;
        }
        
        const kmInfo = `<p class="text-xs text-gray-500">KM: ${os.km ? new Intl.NumberFormat('pt-BR').format(os.km) : 'N/A'}</p>`;

        return `
          <div class="vehicle-card status-${os.status}" data-os-id="${os.id}">
            <div class="flex justify-between items-start">
                <div class="card-clickable-area cursor-pointer flex-grow">
                  <p class="font-bold text-sm text-gray-800">${os.placa}</p>
                  <p class="text-xs text-gray-600">${os.modelo}</p>
                  <div class="text-xs mt-1">${kmInfo}</div>
                  <div class="text-xs">${responsibleInfo}</div>
                </div>
                <div class="flex flex-col -mt-1 -mr-1">
                    ${nextButton}
                    ${prevButton}
                </div>
            </div>
          </div>`;
      };

      const listenToServiceOrders = () => {
        db.ref('serviceOrders').on('value', snapshot => {
          allServiceOrders = snapshot.val() || {};
          Object.keys(allServiceOrders).forEach(id => allServiceOrders[id].id = id);
          const searchInput = document.getElementById('searchDeliveredInput');
          renderKanban(searchInput ? searchInput.value : '');
        }, error => {
          console.error(error);
          showNotification("Erro de conexão com o banco de dados.", 'error');
        });
      };
      
      const updateLedState = () => {
        if (vehiclesTriggeringAlert.size > 0 && attentionPanelContainer.classList.contains('collapsed')) {
            alertLed.classList.remove('hidden');
        } else {
            alertLed.classList.add('hidden');
        }
      };

      const updateServiceOrderStatus = (osId, newStatus) => {
        const os = allServiceOrders[osId];
        if (!os) return;

        const updates = { status: newStatus, lastUpdate: new Date().toISOString() };
        
        if (newStatus === 'Em-Analise') updates.responsibleForBudget = currentUser.name;
        else if (newStatus === 'Em-Execucao') updates.responsibleForService = currentUser.name;
        else if (newStatus === 'Entregue') updates.responsibleForDelivery = currentUser.name;

        db.ref(`serviceOrders/${osId}`).update(updates);
        
        vehiclesTriggeringAlert.delete(osId);
        if (Object.keys(ATTENTION_STATUSES).includes(newStatus)) {
            vehiclesTriggeringAlert.add(osId);
        }
        updateLedState();
        
        const logEntry = {
          type: 'status',
          description: `Status alterado para: ${formatStatus(newStatus)}`,
          user: currentUser.name,
          timestamp: new Date().toISOString()
        };
        db.ref(`serviceOrders/${osId}/timeline`).push(logEntry)
          .catch(err => showNotification("Erro ao registrar a mudança de status.", 'error'));
      };

      const openOsModal = (os = null) => {
        osForm.reset();
        document.getElementById('osId').value = os ? os.id : '';
        document.getElementById('osModalTitle').textContent = os ? 'Editar Ordem de Serviço' : 'Nova Ordem de Serviço';
        if(os) {
          document.getElementById('osPlaca').value = os.placa;
          document.getElementById('osModelo').value = os.modelo;
          document.getElementById('osCliente').value = os.cliente;
          document.getElementById('osTelefone').value = os.telefone;
          document.getElementById('osKm').value = os.km || '';
          document.getElementById('osObservacoes').value = os.initialNotes;
          document.getElementById('osResponsavel').value = os.responsible;
        }
        osModal.classList.remove('hidden');
        osModal.classList.add('flex');
      };

      const renderDetailsModal = (os) => {
        document.getElementById('detailsPlacaModelo').textContent = `${os.placa} - ${os.modelo}`;
        document.getElementById('detailsCliente').textContent = `Cliente: ${os.cliente}`;
        document.getElementById('detailsKm').textContent = `KM: ${os.km ? new Intl.NumberFormat('pt-BR').format(os.km) : 'Não informado'}`;
        document.getElementById('logOsId').value = os.id;
        document.getElementById('updateKmInput').value = os.km || '';
        postLogActions.classList.add('hidden');
        logForm.style.display = 'flex';
        
        const responsiblesContainer = document.getElementById('responsiblesContainer');
        responsiblesContainer.innerHTML = `
            <div><strong>Atendente:</strong> ${os.responsible || 'N/D'}</div>
            <div><strong>Orçamento:</strong> ${os.responsibleForBudget || 'N/D'}</div>
            <div><strong>Serviço:</strong> ${os.responsibleForService || 'N/D'}</div>
            <div><strong>Entrega:</strong> ${os.responsibleForDelivery || 'N/D'}</div>
        `;

        const timelineContainer = document.getElementById('timelineContainer');
        timelineContainer.innerHTML = '';
        
        const allMedia = [];
        if (os.timeline) {
          Object.values(os.timeline).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(log => {
            timelineContainer.innerHTML += createTimelineItemHTML(log);
            if(log.mediaUrls) allMedia.push(...log.mediaUrls);
          });
        }

        const thumbnailGrid = document.getElementById('thumbnail-grid');
        thumbnailGrid.innerHTML = '';
        if(allMedia.length > 0) {
            document.getElementById('media-gallery-container').style.display = 'block';
            allMedia.forEach((media, index) => {
                const isImage = media.type.startsWith('image/');
                thumbnailGrid.innerHTML += `
                    <div data-index="${index}" class="thumbnail-item w-16 h-16 bg-gray-200 rounded-md flex items-center justify-center cursor-pointer overflow-hidden">
                        ${isImage ? `<img src="${media.url}" class="w-full h-full object-cover">` : `<i class='bx bxs-video text-3xl text-gray-500'></i>`}
                    </div>
                `;
            });
            lightboxMedia = allMedia;
        } else {
            document.getElementById('media-gallery-container').style.display = 'none';
        }

        detailsModal.classList.remove('hidden');
        detailsModal.classList.add('flex');
      };

      const createTimelineItemHTML = (log) => {
        const date = new Date(log.timestamp);
        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        
        let iconHTML = `<i class='bx bx-notepad'></i>`;
        let itemClass = 'timeline-item-log';
        if (log.type === 'status') {
          iconHTML = `<i class='bx bx-flag'></i>`;
          itemClass = 'timeline-item-status';
        } else if (log.valor) {
          iconHTML = `<i class='bx bx-dollar'></i>`;
          itemClass = 'timeline-item-value';
        }
        return `
          <div class="timeline-item ${itemClass}">
            <div class="timeline-icon">${iconHTML}</div>
            <div class="bg-white p-4 rounded-lg shadow-sm">
              <p class="font-semibold text-gray-800">${log.description}</p>
              ${log.pecas ? `<p class="text-sm text-gray-600"><strong>Peças:</strong> ${log.pecas}</p>` : ''}
              ${log.valor ? `<p class="text-sm text-gray-600"><strong>Valor:</strong> R$ ${parseFloat(log.valor).toFixed(2)}</p>` : ''}
              <p class="text-xs text-gray-400 mt-2 text-right">${log.user} em ${formattedDate}</p>
            </div>
          </div>`;
      };
      
      const openLightbox = (index) => {
        currentLightboxIndex = index;
        const media = lightboxMedia[index];
        const content = document.getElementById('lightbox-content');
        if (media.type.startsWith('image/')) {
            content.innerHTML = `<img src="${media.url}" alt="Mídia da O.S.">`;
        } else {
            content.innerHTML = `<div class="text-white text-center"><p class="mb-4">Vídeo ou outro arquivo. Clique para abrir.</p><a href="${media.url}" target="_blank" class="btn bg-blue-600 text-white px-4 py-2">Abrir Mídia</a></div>`;
        }
        document.getElementById('lightbox-download').href = media.url;
        lightbox.classList.remove('hidden');
        lightbox.classList.add('flex');
      };
      
      const changeLightboxItem = (direction) => {
        currentLightboxIndex += direction;
        if (currentLightboxIndex < 0) currentLightboxIndex = lightboxMedia.length - 1;
        if (currentLightboxIndex >= lightboxMedia.length) currentLightboxIndex = 0;
        openLightbox(currentLightboxIndex);
      };

      document.addEventListener('click', (e) => {
        if (e.target.closest('.user-btn')) loginUser(JSON.parse(e.target.closest('.user-btn').dataset.user));
        if (e.target.closest('.card-clickable-area')) {
          const osId = e.target.closest('.vehicle-card').dataset.osId;
          if (allServiceOrders[osId]) renderDetailsModal(allServiceOrders[osId]);
        }
        if (e.target.closest('.btn-close-modal')) e.target.closest('.modal').classList.add('hidden');
        if (e.target.closest('.btn-move-status')) {
          const btn = e.target.closest('.btn-move-status');
          updateServiceOrderStatus(btn.dataset.osId, btn.dataset.newStatus);
        }
        if (e.target.closest('.thumbnail-item')) {
            openLightbox(parseInt(e.target.closest('.thumbnail-item').dataset.index));
        }
        if (e.target.closest('.toggle-column-btn')) {
            const status = e.target.closest('.toggle-column-btn').dataset.status;
            const list = document.querySelector(`.vehicle-list[data-status="${status}"]`);
            const icon = e.target.closest('.toggle-column-btn').querySelector('i');
            list.classList.toggle('collapsed');
            icon.classList.toggle('rotate-180');
            const collapsedState = JSON.parse(localStorage.getItem('collapsedColumns')) || {};
            collapsedState[status] = list.classList.contains('collapsed');
            localStorage.setItem('collapsedColumns', JSON.stringify(collapsedState));
        }
        if(e.target.closest('.attention-vehicle')) {
            const osId = e.target.closest('.attention-vehicle').dataset.osId;
            const os = allServiceOrders[osId];
            if(!os) return;
            
            const allowedRoles = ['Gestor', 'Atendente'];
            if (allowedRoles.includes(currentUser.role)) {
                const logEntry = {
                    type: 'log',
                    description: `Alerta de status (${formatStatus(os.status)}) visualizado.`,
                    user: currentUser.name,
                    timestamp: new Date().toISOString()
                };
                db.ref(`serviceOrders/${osId}/timeline`).push(logEntry);
            }
            vehiclesTriggeringAlert.delete(osId);
            updateLedState();
            renderDetailsModal(os);
        }
      });
      
      addOSBtn.addEventListener('click', () => openOsModal());
      logoutButton.addEventListener('click', () => {
        localStorage.removeItem('currentUser');
        window.location.reload();
      });

      osForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const osId = document.getElementById('osId').value;
        const osData = {
          placa: document.getElementById('osPlaca').value.toUpperCase(),
          modelo: document.getElementById('osModelo').value,
          cliente: document.getElementById('osCliente').value,
          telefone: document.getElementById('osTelefone').value,
          km: document.getElementById('osKm').value || null,
          responsible: document.getElementById('osResponsavel').value,
          initialNotes: document.getElementById('osObservacoes').value,
          lastUpdate: new Date().toISOString(),
        };
        if (osId) {
          db.ref(`serviceOrders/${osId}`).update(osData)
            .then(() => showNotification("O.S. atualizada!"))
            .catch(err => showNotification("Erro ao atualizar O.S.", 'error'));
        } else {
          osData.status = 'Aguardando-Mecanico';
          osData.entryDate = new Date().toISOString();
          const newOsRef = db.ref('serviceOrders').push(osData);
          const logEntry = { type: 'status', description: 'Ordem de Serviço criada.', user: currentUser.name, timestamp: new Date().toISOString() };
          newOsRef.child('timeline').push(logEntry);
          showNotification("O.S. criada com sucesso!");
        }
        osModal.classList.add('hidden');
      });

      logForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        
        const osId = document.getElementById('logOsId').value;
        const files = filesToUpload;
        let mediaUrls = [];

        if (files && files.length > 0) {
          if (imgbbApiKey === "SUA_CHAVE_API_VAI_AQUI") {
            showNotification("Configure sua chave de API do ImgBB no código.", 'error');
            submitBtn.disabled = false;
            return;
          }
          const uploadPromises = Array.from(files).map((file, index) => {
            submitBtn.innerHTML = `<i class='bx bx-loader-alt bx-spin'></i> Enviando ${index + 1}/${files.length}...`;
            const formData = new FormData();
            formData.append('image', file);
            return fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, { method: 'POST', body: formData })
              .then(res => res.json())
              .then(result => {
                if (result.success) return { type: file.type, url: result.data.url };
                else throw new Error(result.error.message);
              });
          });
          try {
            mediaUrls = await Promise.all(uploadPromises);
          } catch(error) {
            showNotification(`Erro no upload: ${error.message}`, 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = `<i class='bx bx-message-square-add'></i> Adicionar ao Histórico`;
            return;
          }
        }

        const logEntry = {
          type: 'log',
          description: document.getElementById('logDescricao').value,
          pecas: document.getElementById('logPecas').value || null,
          valor: document.getElementById('logValor').value || null,
          mediaUrls: mediaUrls.length > 0 ? mediaUrls : null,
          user: currentUser.name,
          timestamp: new Date().toISOString()
        };

        db.ref(`serviceOrders/${osId}/timeline`).push(logEntry)
          .then(() => {
            showNotification("Registro adicionado ao histórico!");
            logForm.style.display = 'none';
            postLogActions.classList.remove('hidden');
            const os = allServiceOrders[osId];
            const currentIndex = STATUS_LIST.indexOf(os.status);
            document.getElementById('btn-move-next').onclick = () => {
                if(currentIndex < STATUS_LIST.length - 1) updateServiceOrderStatus(osId, STATUS_LIST[currentIndex + 1]);
                detailsModal.classList.add('hidden');
            };
            document.getElementById('btn-move-prev').onclick = () => {
                if(currentIndex > 0) updateServiceOrderStatus(osId, STATUS_LIST[currentIndex - 1]);
                detailsModal.classList.add('hidden');
            };
            document.getElementById('btn-stay').onclick = () => {
                detailsModal.classList.add('hidden');
            };
            
            logForm.reset();
            document.getElementById('fileName').textContent = '';
            filesToUpload = null;
          })
          .catch(err => showNotification("Erro ao salvar registro.", 'error'))
          .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `<i class='bx bx-message-square-add'></i> Adicionar ao Histórico`;
          });
      });
      
      kmUpdateForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const osId = document.getElementById('logOsId').value;
          const newKm = document.getElementById('updateKmInput').value;
          if (!newKm || !osId) return;

          db.ref(`serviceOrders/${osId}/km`).set(parseInt(newKm));
          const logEntry = {
              type: 'log',
              description: `KM atualizado para ${new Intl.NumberFormat('pt-BR').format(newKm)} km`,
              user: currentUser.name,
              timestamp: new Date().toISOString()
          };
          db.ref(`serviceOrders/${osId}/timeline`).push(logEntry)
            .then(() => {
                showNotification("KM atualizado com sucesso!");
                if (allServiceOrders[osId]) {
                    db.ref(`serviceOrders/${osId}`).once('value', snapshot => renderDetailsModal(snapshot.val()));
                }
            })
            .catch(err => showNotification("Erro ao salvar KM.", 'error'));
      });
      
      openCameraBtn.addEventListener('click', () => {
        mediaInput.removeAttribute('multiple');
        mediaInput.setAttribute('capture', 'environment');
        mediaInput.click();
      });

      openGalleryBtn.addEventListener('click', () => {
        mediaInput.removeAttribute('capture');
        mediaInput.setAttribute('multiple', 'true');
        mediaInput.click();
      });

      mediaInput.addEventListener('change', (e) => {
        filesToUpload = e.target.files;
        const fileNameEl = document.getElementById('fileName');
        const count = filesToUpload.length;
        fileNameEl.textContent = count > 0 ? `${count} arquivo(s) selecionado(s)` : '';
      });

      document.getElementById('deleteOsBtn').addEventListener('click', () => {
        const allowedRoles = ['Gestor', 'Atendente'];
        if (!allowedRoles.includes(currentUser.role)) {
          showNotification("Apenas Gestores e Atendentes podem excluir uma O.S.", 'error');
          return;
        }
        const osId = document.getElementById('logOsId').value;
        db.ref(`serviceOrders/${osId}`).remove()
          .then(() => {
            showNotification("O.S. excluída com sucesso.");
            detailsModal.classList.add('hidden');
          })
          .catch(err => showNotification("Erro ao excluir O.S.", 'error'));
      });

      togglePanelBtn.addEventListener('click', () => {
        const container = document.getElementById('attention-panel-container');
        container.classList.toggle('collapsed');
        const icon = togglePanelBtn.querySelector('i');
        icon.classList.toggle('bxs-chevron-up');
        icon.classList.toggle('bxs-chevron-down');
        if (!container.classList.contains('collapsed')) {
            vehiclesTriggeringAlert.clear();
            updateLedState();
        }
      });

      document.getElementById('lightbox-close').addEventListener('click', () => lightbox.classList.add('hidden'));
      document.getElementById('lightbox-close-bg').addEventListener('click', () => lightbox.classList.add('hidden'));
      document.getElementById('lightbox-prev').addEventListener('click', () => changeLightboxItem(-1));
      document.getElementById('lightbox-next').addEventListener('click', () => changeLightboxItem(1));
      document.getElementById('lightbox-copy').addEventListener('click', () => {
          navigator.clipboard.writeText(lightboxMedia[currentLightboxIndex].url);
          showNotification("Link copiado!", "success");
      });

      const osResponsavelSelect = document.getElementById('osResponsavel');
      osResponsavelSelect.innerHTML = '<option value="">Selecione um responsável...</option>' + USERS.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
      checkLoggedInUser();
      updateAttentionPanel();
    });
  </script>
</body>
</html>
