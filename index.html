<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Oficina - Sistema de Gest√£o</title>
  <!-- TailwindCSS CDN para estiliza√ß√£o r√°pida e responsiva -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Boxicons para √≠cones -->
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <!-- SortableJS para funcionalidade de arrastar e soltar -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .dashboard-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    .status-column {
      background: #f8fafc;
      border-radius: 12px;
      min-height: 600px;
      border: 2px dashed #e2e8f0;
      transition: all 0.3s ease;
    }
    .status-column.drag-over {
      border-color: #3b82f6;
      background: #eff6ff;
      transform: scale(1.02);
    }
    .vehicle-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      cursor: grab;
      transition: all 0.3s ease;
      border-left: 5px solid #3b82f6;
    }
    .vehicle-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .vehicle-card.dragging {
      opacity: 0.7;
      transform: rotate(5deg);
    }
    .vehicle-card.status-Aguardando-Mecanico { border-left-color: #f59e0b; }
    .vehicle-card.status-Em-Analise-Aguardando-Evidencias { border-left-color: #8b5cf6; }
    .vehicle-card.status-Orcamento-Enviado-ao-Cliente { border-left-color: #06b6d4; }
    .vehicle-card.status-Orcamento-Aprovado { border-left-color: #10b981; }
    .vehicle-card.status-Veiculo-em-Manutencao { border-left-color: #ef4444; }
    .vehicle-card.status-Aguardando-Retirada { border-left-color: #f97316; }
    .vehicle-card.status-Veiculo-Entregue { border-left-color: #6b7280; opacity: 0.8; }

    .modal {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      max-height: 90vh;
      overflow-y: auto;
    }
    .btn {
      transition: all 0.3s ease;
      border-radius: 8px;
      font-weight: 600;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.success { background: #10b981; }
    .notification.error { background: #ef4444; }
    .notification.info { background: #3b82f6; }
    .user-btn { 
      padding: 12px; margin: 4px; background: #f1f5f9; border: 1px solid #ddd; 
      border-radius: 8px; text-align: center; font-weight: 500; cursor: pointer; 
      transition: all 0.3s ease;
    }
    .user-btn:hover { 
      background: #e2e8f0; transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>

  <!-- Tela de Sele√ß√£o de Usu√°rio (Login) -->
  <div id="userScreen" class="flex items-center justify-center min-h-screen bg-blue-50 p-4">
    <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-md text-center">
      <h1 class="text-3xl font-bold text-blue-800 mb-2">üõ†Ô∏è Dashboard Oficina</h1>
      <p class="text-gray-600 mb-6">Sistema de Gest√£o Profissional</p>
      <p class="text-gray-600 mb-6">Selecione seu nome para entrar:</p>
      <div id="userList" class="grid grid-cols-1 gap-3">
        <!-- Usu√°rios ser√£o carregados aqui -->
      </div>
    </div>
  </div>

  <!-- App Principal (Dashboard) -->
  <div id="app" class="hidden">
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <i class='bx bx-wrench text-3xl text-blue-600'></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Dashboard Oficina</h1>
                        <p class="text-sm text-gray-600">Bem-vindo, <span id="currentUserName" class="font-semibold"></span>!</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="addVehicleBtn" class="btn bg-green-600 text-white px-4 py-2 flex items-center space-x-2">
                        <i class='bx bx-plus'></i>
                        <span>Novo Ve√≠culo</span>
                    </button>
                    <button id="logoutButton" class="btn bg-red-600 text-white px-4 py-2">Sair</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div class="dashboard-container p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-7 gap-6" id="kanbanBoard">
                <!-- Colunas do Kanban ser√£o geradas aqui -->
            </div>
        </div>
    </main>

    <!-- Modal: Adicionar/Editar Ve√≠culo -->
    <div id="vehicleModal" class="modal fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-content w-full max-w-md mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modalTitle" class="text-2xl font-bold text-gray-800">Novo Ve√≠culo</h2>
                    <button class="close-modal text-gray-500 hover:text-gray-700">
                        <i class='bx bx-x text-2xl'></i>
                    </button>
                </div>
                <form id="vehicleForm" class="space-y-4">
                    <input type="hidden" id="vehicleId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Placa</label>
                        <input type="text" id="placa" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="ABC-1234">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Modelo</label>
                        <input type="text" id="modelo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Gol 2018">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                        <input type="text" id="cliente" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Jo√£o Silva">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                        <input type="tel" id="telefone" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="(DD) 99999-9999">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes</label>
                        <textarea id="observacoes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Respons√°vel</label>
                        <select id="responsavel" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </select>
                    </div>
                    <button type="submit" class="btn bg-blue-600 text-white w-full py-3 mt-4 flex items-center justify-center space-x-2">
                        <i class='bx bx-save'></i>
                        <span id="modalSubmitButton">Adicionar Ve√≠culo</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Detalhes do Ve√≠culo -->
    <div id="vehicleDetailsModal" class="modal fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-content w-full max-w-2xl mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Detalhes do Ve√≠culo</h2>
                    <button class="close-modal text-gray-500 hover:text-gray-700">
                        <i class='bx bx-x text-2xl'></i>
                    </button>
                </div>
                <div id="vehicleDetailsContent" class="space-y-4"></div>
                <div class="mt-6 flex justify-end space-x-2">
                    <button id="editVehicleBtn" class="btn bg-yellow-500 text-white px-4 py-2 flex items-center space-x-2">
                        <i class='bx bx-edit'></i><span>Editar</span>
                    </button>
                    <button id="addEvidenceBtnDetails" class="btn bg-green-500 text-white px-4 py-2 flex items-center space-x-2">
                        <i class='bx bx-plus-circle'></i><span>Adicionar Evid√™ncia</span>
                    </button>
                    <button id="deleteVehicleBtn" class="btn bg-red-500 text-white px-4 py-2 flex items-center space-x-2">
                        <i class='bx bx-trash'></i><span>Excluir</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar Evid√™ncia -->
    <div id="addEvidenceModal" class="modal fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-content w-full max-w-md mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Adicionar Evid√™ncia</h2>
                    <button class="close-modal text-gray-500 hover:text-gray-700">
                        <i class='bx bx-x text-2xl'></i>
                    </button>
                </div>
                <form id="addEvidenceForm" class="space-y-4">
                    <input type="hidden" id="evidenceVehicleId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Problema/Servi√ßo</label>
                        <textarea id="problema" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pe√ßas Utilizadas</label>
                        <input type="text" id="pecas" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor (R$)</label>
                        <input type="number" id="valor" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Link da Imagem (Opcional)</label>
                        <input type="url" id="evidenceImageUrl" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="https://imgur.com/exemplo.jpg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Link do V√≠deo (Opcional)</label>
                        <input type="url" id="evidenceVideoUrl" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="https://youtube.com/watch?v=...">
                    </div>
                    <button type="submit" class="btn bg-blue-600 text-white w-full py-3 mt-4 flex items-center justify-center space-x-2">
                        <i class='bx bx-link-alt'></i>
                        <span>Adicionar Evid√™ncia</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Notifica√ß√£o -->
    <div id="notification" class="notification"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // --- CONFIGURA√á√ÉO DO FIREBASE (SUBSTITUA PELAS SUAS CHAVES) --- //
        const firebaseConfig = {
    apiKey: "AIzaSyB5JpYm8l0AlF5ZG3HtkyFZgmrpsUrDhv0",
    authDomain: "dashboard-oficina-pro.firebaseapp.com",
    databaseURL: "https://dashboard-oficina-pro-default-rtdb.firebaseio.com",
    projectId: "dashboard-oficina-pro",
    storageBucket: "dashboard-oficina-pro.firebasestorage.app",
    messagingSenderId: "736157192887",
    appId: "1:736157192887:web:c23d3daade848a33d67332"
  };

        // --- CORRE√á√ÉO AUTOM√ÅTICA DA DATABASEURL --- //
        if (firebaseConfig.projectId && (!firebaseConfig.databaseURL || firebaseConfig.databaseURL.includes("YOUR_DATABASE_URL"))) {
            firebaseConfig.databaseURL = `https://${firebaseConfig.projectId}.firebaseio.com`;
        }

        // --- INICIALIZA√á√ÉO DO FIREBASE --- //
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        // A constante 'storage' foi removida pois n√£o √© mais necess√°ria.

        // --- VARI√ÅVEIS GLOBAIS --- //
        let currentUser = null;
        const USERS = [
            { name: 'Augusto', role: 'Gestor' },
            { name: 'William Barbosa', role: 'Atendente' },
            { name: 'Thiago Ventura Valencio', role: 'Atendente' },
            { name: 'Fernando', role: 'Mec√¢nico' },
            { name: 'Gustavo', role: 'Mec√¢nico' },
            { name: 'Marcelo', role: 'Mec√¢nico' }
        ];
        const STATUS_LIST = [
            'Aguardando Mec√¢nico', 'Em An√°lise (Aguardando Evid√™ncias)', 'Or√ßamento Enviado ao Cliente', 
            'Or√ßamento Aprovado', 'Ve√≠culo em Manuten√ß√£o', 'Aguardando Retirada', 'Ve√≠culo Entregue'
        ];
        
        // --- ELEMENTOS DO DOM --- //
        const userScreen = document.getElementById('userScreen');
        const app = document.getElementById('app');
        const userList = document.getElementById('userList');
        const kanbanBoard = document.getElementById('kanbanBoard');
        const logoutButton = document.getElementById('logoutButton');
        const addVehicleBtn = document.getElementById('addVehicleBtn');
        const vehicleModal = document.getElementById('vehicleModal');
        const vehicleForm = document.getElementById('vehicleForm');
        const vehicleDetailsModal = document.getElementById('vehicleDetailsModal');
        const addEvidenceModal = document.getElementById('addEvidenceModal');
        const addEvidenceForm = document.getElementById('addEvidenceForm');
        const notificationElement = document.getElementById('notification');
        const closeModals = document.querySelectorAll('.close-modal');

        // --- FUN√á√ïES DE UTILIDADE --- //
        const showNotification = (message, type = 'info') => {
            notificationElement.textContent = message;
            notificationElement.className = `notification show ${type}`;
            setTimeout(() => notificationElement.classList.remove('show'), 3000);
        };

        const slugify = str => str.replace(/\s+/g, '-').replace(/[^\w-]+/g, '');

        // --- L√ìGICA DE AUTENTICA√á√ÉO E LOGIN --- //
        const populateUserSelection = () => {
            userList.innerHTML = '';
            USERS.forEach(user => {
                const userBtn = document.createElement('div');
                userBtn.className = 'user-btn';
                userBtn.textContent = `${user.name} (${user.role})`;
                userBtn.onclick = () => loginUser(user);
                userList.appendChild(userBtn);
            });
        };

        const loginUser = (user) => {
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            userScreen.classList.add('hidden');
            app.classList.remove('hidden');
            document.getElementById('currentUserName').textContent = user.name;
            listenToVehicles();
        };

        const checkLoggedInUser = () => {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                loginUser(JSON.parse(storedUser));
            } else {
                populateUserSelection();
            }
        };

        logoutButton.addEventListener('click', () => {
            currentUser = null;
            localStorage.removeItem('currentUser');
            app.classList.add('hidden');
            userScreen.classList.remove('hidden');
            db.ref('vehicles').off(); // Para de escutar as mudan√ßas
        });

        // --- L√ìGICA DO KANBAN --- //
        const createKanbanColumns = () => {
            kanbanBoard.innerHTML = '';
            STATUS_LIST.forEach(status => {
                const slug = slugify(status);
                const column = document.createElement('div');
                column.className = 'status-column';
                column.dataset.status = status;
                column.innerHTML = `
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="font-bold text-gray-800 flex items-center">${status}</h3>
                    </div>
                    <div class="p-4 vehicle-list" id="list-${slug}"></div>
                `;
                kanbanBoard.appendChild(column);
            });
            setupDragAndDrop();
        };

        const createVehicleCard = (vehicleId, vehicleData) => {
            const slugStatus = slugify(vehicleData.status);
            const card = document.createElement('div');
            card.className = `vehicle-card fade-in status-${slugStatus}`;
            card.dataset.id = vehicleId;
            card.innerHTML = `
                <p class="font-bold text-gray-800">${vehicleData.placa} - ${vehicleData.modelo}</p>
                <p class="text-sm text-gray-600">Cliente: ${vehicleData.cliente}</p>
                <p class="text-sm text-gray-500">Respons√°vel: ${vehicleData.responsavel}</p>
            `;
            card.onclick = () => showVehicleDetails(vehicleId);
            return card;
        };

        const renderVehicles = (vehicles) => {
            document.querySelectorAll('.vehicle-list').forEach(list => list.innerHTML = '');
            if (vehicles) {
                Object.entries(vehicles).forEach(([id, data]) => {
                    const listId = `list-${slugify(data.status)}`;
                    const listElement = document.getElementById(listId);
                    if (listElement) {
                        const card = createVehicleCard(id, data);
                        listElement.appendChild(card);
                    }
                });
            }
        };

        const listenToVehicles = () => {
            const vehiclesRef = db.ref('vehicles');
            vehiclesRef.on('value', (snapshot) => {
                const vehicles = snapshot.val();
                renderVehicles(vehicles);
            }, (error) => {
                console.error(error);
                showNotification('Erro ao carregar ve√≠culos.', 'error');
            });
        };

        const setupDragAndDrop = () => {
            document.querySelectorAll('.vehicle-list').forEach(list => {
                new Sortable(list, {
                    group: 'vehicles',
                    animation: 150,
                    onEnd: (evt) => {
                        const vehicleId = evt.item.dataset.id;
                        const newStatus = evt.to.parentElement.dataset.status;
                        db.ref(`vehicles/${vehicleId}/status`).set(newStatus)
                            .then(() => showNotification('Status atualizado!', 'success'))
                            .catch(err => showNotification('Erro ao atualizar status.', 'error'));
                    },
                });
            });
        };
        
        // --- L√ìGICA DOS MODAIS --- //
        const populateResponsavelSelect = (selectElement) => {
            selectElement.innerHTML = '<option value="">Selecione...</option>';
            USERS.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = `${user.name} (${user.role})`;
                selectElement.appendChild(option);
            });
        };

        addVehicleBtn.addEventListener('click', () => {
            vehicleForm.reset();
            document.getElementById('modalTitle').textContent = 'Novo Ve√≠culo';
            document.getElementById('modalSubmitButton').textContent = 'Adicionar Ve√≠culo';
            document.getElementById('vehicleId').value = '';
            document.getElementById('placa').disabled = false;
            populateResponsavelSelect(document.getElementById('responsavel'));
            vehicleModal.classList.remove('hidden');
        });

        vehicleForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('vehicleId').value;
            const vehicleData = {
                placa: document.getElementById('placa').value.toUpperCase(),
                modelo: document.getElementById('modelo').value,
                cliente: document.getElementById('cliente').value,
                telefone: document.getElementById('telefone').value,
                observacoes: document.getElementById('observacoes').value,
                responsavel: document.getElementById('responsavel').value,
                ultimaAtualizacao: new Date().toISOString(),
            };
            
            let promise;
            if (id) {
                promise = db.ref(`vehicles/${id}`).update(vehicleData);
            } else {
                vehicleData.status = 'Aguardando Mec√¢nico';
                vehicleData.dataEntrada = new Date().toISOString();
                promise = db.ref('vehicles').push(vehicleData);
            }

            promise.then(() => {
                showNotification(`Ve√≠culo ${id ? 'atualizado' : 'adicionado'} com sucesso!`, 'success');
                vehicleModal.classList.add('hidden');
            }).catch(err => showNotification('Erro ao salvar ve√≠culo.', 'error'));
        });

        const showVehicleDetails = async (vehicleId) => {
            const snapshot = await db.ref(`vehicles/${vehicleId}`).get();
            const evidenceSnapshot = await db.ref('evidence').orderByChild('vehicleId').equalTo(vehicleId).get();
            
            if (snapshot.exists()) {
                const data = snapshot.val();
                const content = document.getElementById('vehicleDetailsContent');
                content.innerHTML = `
                    <p><strong>Placa:</strong> ${data.placa}</p>
                    <p><strong>Modelo:</strong> ${data.modelo}</p>
                    <p><strong>Cliente:</strong> ${data.cliente}</p>
                    <p><strong>Telefone:</strong> ${data.telefone || 'N/A'}</p>
                    <p><strong>Respons√°vel:</strong> ${data.responsavel}</p>
                    <p><strong>Observa√ß√µes:</strong> ${data.observacoes || 'Nenhuma'}</p>
                    <hr>
                    <h4 class="font-bold mt-4">Evid√™ncias</h4>
                    <div id="evidenceList" class="space-y-2">Carregando...</div>
                `;
                
                const evidenceList = document.getElementById('evidenceList');
                evidenceList.innerHTML = '';
                if (evidenceSnapshot.exists()) {
                    evidenceSnapshot.forEach(child => {
                        const ev = child.val();
                        const mediaHTML = (ev.midias || []).map(m => {
                            if (m.type === 'image') {
                                return `<a href="${m.url}" target="_blank" title="Ver imagem"><img src="${m.url}" class="w-20 h-20 object-cover rounded"></a>`;
                            }
                            if (m.type === 'video') {
                                return `<a href="${m.url}" target="_blank" class="w-20 h-20 bg-gray-800 text-white flex items-center justify-center rounded" title="Ver v√≠deo"><i class='bx bx-video text-3xl'></i></a>`;
                            }
                            return '';
                        }).join('');

                        evidenceList.innerHTML += `
                            <div class="p-2 border rounded-lg bg-gray-50">
                                <p>${ev.problema}</p>
                                <p class="text-sm text-gray-500">Pe√ßas: ${ev.pecas || 'N/A'} | Valor: R$ ${ev.valor || 0}</p>
                                <div class="flex flex-wrap gap-2 mt-2">${mediaHTML}</div>
                            </div>
                        `;
                    });
                } else {
                    evidenceList.innerHTML = '<p>Nenhuma evid√™ncia adicionada.</p>';
                }

                document.getElementById('editVehicleBtn').onclick = () => showEditVehicle(vehicleId, data);
                document.getElementById('deleteVehicleBtn').onclick = () => deleteVehicle(vehicleId, data.placa);
                document.getElementById('addEvidenceBtnDetails').onclick = () => showAddEvidence(vehicleId);
                
                vehicleDetailsModal.classList.remove('hidden');
            }
        };

        const showEditVehicle = (id, data) => {
            vehicleDetailsModal.classList.add('hidden');
            vehicleForm.reset();
            document.getElementById('modalTitle').textContent = 'Editar Ve√≠culo';
            document.getElementById('modalSubmitButton').textContent = 'Salvar Altera√ß√µes';
            document.getElementById('vehicleId').value = id;
            document.getElementById('placa').value = data.placa;
            document.getElementById('placa').disabled = true;
            document.getElementById('modelo').value = data.modelo;
            document.getElementById('cliente').value = data.cliente;
            document.getElementById('telefone').value = data.telefone;
            document.getElementById('observacoes').value = data.observacoes;
            populateResponsavelSelect(document.getElementById('responsavel'));
            document.getElementById('responsavel').value = data.responsavel;
            vehicleModal.classList.remove('hidden');
        };

        const deleteVehicle = (id, placa) => {
            if (currentUser.role !== 'Gestor') {
                showNotification('Apenas gestores podem excluir ve√≠culos.', 'error');
                return;
            }
            if (confirm(`Tem certeza que deseja excluir o ve√≠culo ${placa}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                db.ref(`vehicles/${id}`).remove()
                    .then(() => {
                        showNotification('Ve√≠culo exclu√≠do com sucesso!', 'success');
                        vehicleDetailsModal.classList.add('hidden');
                    })
                    .catch(err => showNotification('Erro ao excluir ve√≠culo.', 'error'));
            }
        };
        
        const showAddEvidence = (vehicleId) => {
            vehicleDetailsModal.classList.add('hidden');
            addEvidenceForm.reset();
            document.getElementById('evidenceVehicleId').value = vehicleId;
            addEvidenceModal.classList.remove('hidden');
        };

        addEvidenceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const vehicleId = document.getElementById('evidenceVehicleId').value;
            const imageUrl = document.getElementById('evidenceImageUrl').value.trim();
            const videoUrl = document.getElementById('evidenceVideoUrl').value.trim();

            const midias = [];
            if (imageUrl) midias.push({ type: 'image', url: imageUrl });
            if (videoUrl) midias.push({ type: 'video', url: videoUrl });

            const evidenceData = {
                vehicleId: vehicleId,
                problema: document.getElementById('problema').value,
                pecas: document.getElementById('pecas').value,
                valor: document.getElementById('valor').value,
                responsavel: currentUser.name,
                data: new Date().toISOString(),
                midias: midias
            };

            try {
                await db.ref('evidence').push(evidenceData);
                await db.ref(`vehicles/${vehicleId}/ultimaAtualizacao`).set(new Date().toISOString());
                showNotification('Evid√™ncia adicionada com sucesso!', 'success');
                addEvidenceModal.classList.add('hidden');
            } catch (err) {
                console.error(err);
                showNotification('Erro ao adicionar evid√™ncia.', 'error');
            }
        });

        closeModals.forEach(btn => btn.onclick = () => {
            vehicleModal.classList.add('hidden');
            vehicleDetailsModal.classList.add('hidden');
            addEvidenceModal.classList.add('hidden');
        });

        // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO --- //
        document.addEventListener('DOMContentLoaded', () => {
            createKanbanColumns();
            checkLoggedInUser();
        });
    </script>
</body>
</html>
