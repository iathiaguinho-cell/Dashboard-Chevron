!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Oficina - Gest√£o de P√°tio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #eef2f7;
    }
    .status-column {
      background: #e2e8f0;
      border-radius: 12px;
      min-height: 70vh;
    }
    .vehicle-card {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      cursor: grab;
      transition: all 0.2s ease-in-out;
      border-left: 5px solid #3b82f6;
    }
    .vehicle-card:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
    }
    .vehicle-card.status-Aguardando-Mecanico { border-left-color: #f59e0b; }
    .vehicle-card.status-Em-Analise { border-left-color: #8b5cf6; }
    .vehicle-card.status-Orcamento-Enviado { border-left-color: #06b6d4; }
    .vehicle-card.status-Aguardando-Aprovacao { border-left-color: #d946ef; }
    .vehicle-card.status-Servico-Autorizado { border-left-color: #10b981; }
    .vehicle-card.status-Em-Execucao { border-left-color: #ef4444; }
    .vehicle-card.status-Finalizado-Aguardando-Retirada { border-left-color: #f97316; }
    .vehicle-card.status-Entregue { border-left-color: #6b7280; opacity: 0.8; }

    .modal { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    .modal-content { background: white; border-radius: 16px; max-height: 90vh; }
    .btn { transition: all 0.2s ease; border-radius: 8px; font-weight: 600; }
    .btn:hover { transform: translateY(-2px); }
    
    /* Timeline styles */
    .timeline { border-left: 2px solid #e5e7eb; }
    .timeline-item { position: relative; padding-left: 2rem; }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -0.5rem;
      top: 0.25rem;
      width: 0.875rem;
      height: 0.875rem;
      border-radius: 9999px;
      background-color: white;
      border: 2px solid #9ca3af;
    }
    .timeline-item-log::before { border-color: #3b82f6; }
    .timeline-item-status::before { border-color: #10b981; }
    .timeline-item-budget::before { border-color: #f59e0b; }

    .notification {
      position: fixed; top: 20px; right: 20px; z-index: 1050; padding: 1rem 1.5rem;
      border-radius: 0.75rem; color: white; font-weight: 600;
      transform: translateX(calc(100% + 20px)); transition: transform 0.4s ease-in-out;
    }
    .notification.show { transform: translateX(0); }
    .notification.success { background: #10b981; }
    .notification.error { background: #ef4444; }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Tela de Login -->
  <div id="userScreen" class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">üõ†Ô∏è Gest√£o de P√°tio</h1>
      <p class="text-gray-500 mb-8">Selecione seu perfil para iniciar</p>
      <div id="userList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
    </div>
  </div>

  <!-- App Principal -->
  <div id="app" class="hidden">
    <header class="bg-white shadow-md">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Controle de P√°tio</h1>
        <div class="flex items-center gap-4">
          <button id="addOSBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 flex items-center gap-2">
            <i class='bx bx-plus-circle'></i><span>Nova O.S.</span>
          </button>
          <div class="text-right">
            <p id="currentUserName" class="font-semibold text-gray-700"></p>
            <button id="logoutButton" class="text-sm text-red-500 hover:text-red-700">Sair</button>
          </div>
        </div>
      </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-8 gap-6" id="kanbanBoard">
        <!-- Colunas do Kanban geradas via JS -->
      </div>
    </main>
  </div>

  <!-- Modal: Nova/Editar Ordem de Servi√ßo -->
  <div id="osModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="modal-content w-full max-w-lg overflow-y-auto">
      <form id="osForm" class="p-6">
        <h2 id="osModalTitle" class="text-2xl font-bold text-gray-800 mb-6">Nova Ordem de Servi√ßo</h2>
        <input type="hidden" id="osId">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <input id="osPlaca" type="text" placeholder="Placa" required class="p-2 border rounded w-full">
          <input id="osModelo" type="text" placeholder="Modelo do Ve√≠culo" required class="p-2 border rounded w-full">
          <input id="osCliente" type="text" placeholder="Nome do Cliente" required class="p-2 border rounded w-full">
          <input id="osTelefone" type="tel" placeholder="Telefone" class="p-2 border rounded w-full">
          <select id="osResponsavel" required class="p-2 border rounded w-full col-span-1 sm:col-span-2"></select>
          <textarea id="osObservacoes" placeholder="Observa√ß√µes Iniciais / Queixa do Cliente" rows="3" class="p-2 border rounded w-full col-span-1 sm:col-span-2"></textarea>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" class="btn-close-modal btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2">Cancelar</button>
          <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Detalhes da O.S. -->
  <div id="detailsModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="modal-content w-full max-w-3xl overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h2 id="detailsPlacaModelo" class="text-2xl font-bold text-gray-800"></h2>
            <p id="detailsCliente" class="text-gray-600"></p>
          </div>
          <button class="btn-close-modal text-2xl text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Coluna da Timeline -->
          <div class="lg:pr-4">
            <h3 class="font-bold text-lg mb-4">Hist√≥rico da O.S.</h3>
            <div id="timelineContainer" class="space-y-6 timeline">
              <!-- Itens da Timeline gerados via JS -->
            </div>
          </div>
          <!-- Coluna de A√ß√µes -->
          <div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="font-bold text-lg mb-4">Adicionar Atualiza√ß√£o</h3>
              <form id="logForm" class="space-y-3">
                <input type="hidden" id="logOsId">
                <textarea id="logDescricao" placeholder="Descri√ß√£o do servi√ßo, pe√ßa, observa√ß√£o..." rows="3" required class="p-2 border rounded w-full"></textarea>
                <div class="flex gap-2">
                  <input id="logPecas" type="text" placeholder="Pe√ßas (opcional)" class="p-2 border rounded w-1/2">
                  <input id="logValor" type="number" step="0.01" placeholder="Valor R$ (opcional)" class="p-2 border rounded w-1/2">
                </div>
                <input id="logMediaUrl" type="url" placeholder="Link de Foto ou V√≠deo (opcional)" class="p-2 border rounded w-full">
                <button type="submit" class="w-full btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 flex items-center justify-center gap-2">
                  <i class='bx bx-message-square-add'></i> Adicionar ao Hist√≥rico
                </button>
              </form>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                 <button id="deleteOsBtn" class="btn bg-red-600 hover:bg-red-700 text-white p-2" title="Excluir O.S.">
                    <i class='bx bx-trash'></i>
                 </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // --- CONFIGURA√á√ÉO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyB5JpYm8l0AlF5ZG3HtkyFZgmrpsUrDhv0",
        authDomain: "dashboard-oficina-pro.firebaseapp.com",
        databaseURL: "https://dashboard-oficina-pro-default-rtdb.firebaseio.com",
        projectId: "dashboard-oficina-pro",
        storageBucket: "dashboard-oficina-pro.appspot.com",
        messagingSenderId: "736157192887",
        appId: "1:736157192887:web:c23d3daade848a33d67332"
    };

    // --- INICIALIZA√á√ÉO E L√ìGICA ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- INICIALIZA√á√ÉO FIREBASE ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- VARI√ÅVEIS GLOBAIS E CONSTANTES ---
        let currentUser = null;
        let allServiceOrders = {};
        const USERS = [
            { name: 'Augusto', role: 'Gestor' }, { name: 'William Barbosa', role: 'Atendente' },
            { name: 'Thiago Ventura Valencio', role: 'Atendente' }, { name: 'Fernando', role: 'Mec√¢nico' },
            { name: 'Gustavo', role: 'Mec√¢nico' }, { name: 'Marcelo', role: 'Mec√¢nico' }
        ];
        const STATUS_LIST = [
            'Aguardando-Mecanico', 'Em-Analise', 'Orcamento-Enviado', 'Aguardando-Aprovacao',
            'Servico-Autorizado', 'Em-Execucao', 'Finalizado-Aguardando-Retirada', 'Entregue'
        ];

        // --- REFER√äNCIAS DO DOM ---
        const userScreen = document.getElementById('userScreen');
        const app = document.getElementById('app');
        const userList = document.getElementById('userList');
        const kanbanBoard = document.getElementById('kanbanBoard');
        const addOSBtn = document.getElementById('addOSBtn');
        const logoutButton = document.getElementById('logoutButton');
        const osModal = document.getElementById('osModal');
        const osForm = document.getElementById('osForm');
        const detailsModal = document.getElementById('detailsModal');
        const logForm = document.getElementById('logForm');

        // --- FUN√á√ïES DE UTILIDADE ---
        const showNotification = (message, type = 'success') => {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => notification.classList.remove('show'), 4000);
        };
        const formatStatus = (status) => status.replace(/-/g, ' ');
        const slugify = (text) => text.replace(/\s+/g, '-');

        // --- L√ìGICA DE AUTENTICA√á√ÉO ---
        const loginUser = (user) => {
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            document.getElementById('currentUserName').textContent = user.name;
            userScreen.classList.add('hidden');
            app.classList.remove('hidden');
            listenToServiceOrders();
        };

        const checkLoggedInUser = () => {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) loginUser(JSON.parse(storedUser));
            else {
                userList.innerHTML = USERS.map(user => 
                    `<div class="p-4 bg-gray-100 rounded-lg hover:bg-blue-100 cursor-pointer user-btn" data-user='${JSON.stringify(user)}'>
                        <p class="font-semibold">${user.name}</p>
                        <p class="text-sm text-gray-500">${user.role}</p>
                    </div>`
                ).join('');
            }
        };

        // --- L√ìGICA DO KANBAN ---
        const renderKanban = () => {
            kanbanBoard.innerHTML = STATUS_LIST.map(status => `
                <div class="status-column p-3">
                    <h3 class="font-bold text-gray-700 mb-3 px-1">${formatStatus(status)}</h3>
                    <div class="space-y-3 min-h-[50px] vehicle-list" data-status="${status}"></div>
                </div>
            `).join('');
            
            Object.values(allServiceOrders).forEach(os => {
                const list = kanbanBoard.querySelector(`.vehicle-list[data-status="${os.status}"]`);
                if (list) list.insertAdjacentHTML('beforeend', createCardHTML(os));
            });

            setupDragAndDrop();
        };

        const createCardHTML = (os) => `
            <div class="vehicle-card status-${os.status}" data-os-id="${os.id}">
                <p class="font-bold text-gray-800">${os.placa}</p>
                <p class="text-sm text-gray-600">${os.modelo}</p>
                <p class="text-xs text-gray-400 mt-2">Cliente: ${os.cliente}</p>
            </div>
        `;

        const setupDragAndDrop = () => {
            document.querySelectorAll('.vehicle-list').forEach(list => {
                new Sortable(list, {
                    group: 'vehicles',
                    animation: 150,
                    onEnd: (evt) => {
                        const osId = evt.item.dataset.osId;
                        const newStatus = evt.to.dataset.status;
                        updateServiceOrderStatus(osId, newStatus);
                    }
                });
            });
        };

        // --- L√ìGICA DE DADOS (FIREBASE) ---
        const listenToServiceOrders = () => {
            db.ref('serviceOrders').on('value', snapshot => {
                allServiceOrders = snapshot.val() || {};
                // Adiciona o ID a cada objeto para f√°cil refer√™ncia
                Object.keys(allServiceOrders).forEach(id => allServiceOrders[id].id = id);
                renderKanban();
            }, error => {
                console.error(error);
                showNotification("Erro de conex√£o com o banco de dados.", 'error');
            });
        };

        const updateServiceOrderStatus = (osId, newStatus) => {
            const updates = {
                status: newStatus,
                lastUpdate: new Date().toISOString()
            };
            db.ref(`serviceOrders/${osId}`).update(updates);
            
            const logEntry = {
                type: 'status',
                description: `Status alterado para: ${formatStatus(newStatus)}`,
                user: currentUser.name,
                timestamp: new Date().toISOString()
            };
            db.ref(`serviceOrders/${osId}/timeline`).push(logEntry)
              .then(() => showNotification("Status atualizado!"))
              .catch(err => showNotification("Erro ao registrar a mudan√ßa de status.", 'error'));
        };

        // --- L√ìGICA DOS MODAIS ---
        const openOsModal = (os = null) => {
            osForm.reset();
            document.getElementById('osId').value = os ? os.id : '';
            document.getElementById('osModalTitle').textContent = os ? 'Editar Ordem de Servi√ßo' : 'Nova Ordem de Servi√ßo';
            if(os) {
                document.getElementById('osPlaca').value = os.placa;
                document.getElementById('osModelo').value = os.modelo;
                document.getElementById('osCliente').value = os.cliente;
                document.getElementById('osTelefone').value = os.telefone;
                document.getElementById('osObservacoes').value = os.initialNotes;
                document.getElementById('osResponsavel').value = os.responsible;
            }
            osModal.classList.remove('hidden');
            osModal.classList.add('flex');
        };

        const renderDetailsModal = (os) => {
            document.getElementById('detailsPlacaModelo').textContent = `${os.placa} - ${os.modelo}`;
            document.getElementById('detailsCliente').textContent = `Cliente: ${os.cliente}`;
            document.getElementById('logOsId').value = os.id;
            
            const timelineContainer = document.getElementById('timelineContainer');
            timelineContainer.innerHTML = '';
            if (os.timeline) {
                Object.values(os.timeline).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(log => {
                    timelineContainer.innerHTML += createTimelineItemHTML(log);
                });
            }
            detailsModal.classList.remove('hidden');
            detailsModal.classList.add('flex');
        };
        
        const createTimelineItemHTML = (log) => {
            const date = new Date(log.timestamp);
            const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            let iconClass = 'timeline-item-log';
            if(log.type === 'status') iconClass = 'timeline-item-status';
            if(log.type === 'budget') iconClass = 'timeline-item-budget';

            return `
                <div class="timeline-item ${iconClass}">
                    <p class="font-semibold text-gray-800">${log.description}</p>
                    ${log.pecas ? `<p class="text-sm text-gray-600">Pe√ßas: ${log.pecas}</p>` : ''}
                    ${log.valor ? `<p class="text-sm text-gray-600">Valor: R$ ${log.valor}</p>` : ''}
                    ${log.mediaUrl ? `<a href="${log.mediaUrl}" target="_blank" class="text-sm text-blue-500 hover:underline">Ver M√≠dia</a>` : ''}
                    <p class="text-xs text-gray-400 mt-1">${log.user} em ${formattedDate}</p>
                </div>
            `;
        };
        
        // --- EVENT LISTENERS ---
        document.addEventListener('click', (e) => {
            // Login
            if (e.target.closest('.user-btn')) {
                loginUser(JSON.parse(e.target.closest('.user-btn').dataset.user));
            }
            // Abrir modal de detalhes
            if (e.target.closest('.vehicle-card')) {
                const osId = e.target.closest('.vehicle-card').dataset.osId;
                if (allServiceOrders[osId]) renderDetailsModal(allServiceOrders[osId]);
            }
            // Fechar modais
            if (e.target.closest('.btn-close-modal')) {
                e.target.closest('.modal').classList.add('hidden');
                e.target.closest('.modal').classList.remove('flex');
            }
        });
        
        addOSBtn.addEventListener('click', () => openOsModal());
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('currentUser');
            window.location.reload();
        });

        osForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const osId = document.getElementById('osId').value;
            const osData = {
                placa: document.getElementById('osPlaca').value.toUpperCase(),
                modelo: document.getElementById('osModelo').value,
                cliente: document.getElementById('osCliente').value,
                telefone: document.getElementById('osTelefone').value,
                responsible: document.getElementById('osResponsavel').value,
                initialNotes: document.getElementById('osObservacoes').value,
                lastUpdate: new Date().toISOString(),
            };

            if (osId) { // Editando
                db.ref(`serviceOrders/${osId}`).update(osData)
                  .then(() => showNotification("O.S. atualizada com sucesso!"))
                  .catch(err => showNotification("Erro ao atualizar O.S.", 'error'));
            } else { // Criando
                osData.status = 'Aguardando-Mecanico';
                osData.entryDate = new Date().toISOString();
                const newOsRef = db.ref('serviceOrders').push(osData);
                const logEntry = {
                    type: 'status',
                    description: 'Ordem de Servi√ßo criada.',
                    user: currentUser.name,
                    timestamp: new Date().toISOString()
                };
                newOsRef.child('timeline').push(logEntry);
                showNotification("O.S. criada com sucesso!");
            }
            osModal.classList.add('hidden');
            osModal.classList.remove('flex');
        });

        logForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const osId = document.getElementById('logOsId').value;
            const logEntry = {
                type: 'log',
                description: document.getElementById('logDescricao').value,
                pecas: document.getElementById('logPecas').value || null,
                valor: document.getElementById('logValor').value || null,
                mediaUrl: document.getElementById('logMediaUrl').value || null,
                user: currentUser.name,
                timestamp: new Date().toISOString()
            };
            db.ref(`serviceOrders/${osId}/timeline`).push(logEntry)
              .then(() => {
                  showNotification("Registro adicionado ao hist√≥rico!");
                  logForm.reset();
                  // For√ßar atualiza√ß√£o do modal
                  if (allServiceOrders[osId]) {
                      db.ref(`serviceOrders/${osId}`).once('value', snapshot => {
                         renderDetailsModal(snapshot.val());
                      });
                  }
              })
              .catch(err => showNotification("Erro ao salvar registro.", 'error'));
        });
        
        document.getElementById('deleteOsBtn').addEventListener('click', () => {
            if(currentUser.role !== 'Gestor') {
                showNotification("Apenas gestores podem excluir uma O.S.", 'error');
                return;
            }
            const osId = document.getElementById('logOsId').value;
            if(confirm("ATEN√á√ÉO: Excluir uma Ordem de Servi√ßo √© uma a√ß√£o permanente e n√£o pode ser desfeita. Deseja continuar?")) {
                db.ref(`serviceOrders/${osId}`).remove()
                  .then(() => {
                      showNotification("O.S. exclu√≠da com sucesso.");
                      detailsModal.classList.add('hidden');
                      detailsModal.classList.remove('flex');
                  })
                  .catch(err => showNotification("Erro ao excluir O.S.", 'error'));
            }
        });

        // --- INICIALIZA√á√ÉO ---
        const osResponsavelSelect = document.getElementById('osResponsavel');
        osResponsavelSelect.innerHTML = '<option value="">Selecione um respons√°vel...</option>' + USERS.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
        checkLoggedInUser();
    });
  </script>
</body>
</html>
